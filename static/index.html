<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>FirstVerify AI Agent V8.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
        }

        .report-table {
            font-size: 0.85rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sticky-controls {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: #f8f9fa;
            padding-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="sticky-controls">
            <h2 class="mb-4 text-center">FirstVerify AI <span class="badge bg-primary">V8.2 Enterprise</span></h2>
            <div class="card p-4 shadow-sm">
                <div class="row g-3">
                    <div class="col-md-2"><label class="form-label fw-bold">Extraction ID</label><input type="number"
                            id="ext_id" class="form-control" value="3053"></div>
                    <div class="col-md-6"><label class="form-label fw-bold">Ask a Question</label><input type="text"
                            id="q" class="form-control" placeholder="Search safety, financials, or limits..."></div>
                    <div class="col-md-4 d-flex align-items-end gap-2">
                        <button onclick="askAI()" id="aiBtn" class="btn btn-primary w-100">AI Search</button>
                        <button onclick="loadDashboard('Safety')" id="safeBtn"
                            class="btn btn-success w-100">Safety</button>
                        <button onclick="loadDashboard('Financials')" id="finBtn"
                            class="btn btn-warning w-100">Financials</button>
                    </div>
                </div>
                <div id="statusInfo" class="mt-2 text-muted small">System Ready.</div>
            </div>
        </div>

        <div id="reportArea" class="d-none mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div id="paginationControls" class="btn-group shadow-sm"></div>
                <div id="statsInfo" class="fw-bold text-primary"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover report-table">
                    <thead id="h" class="table-dark"></thead>
                    <tbody id="b"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let masterData = []; let masterCols = []; let currentPage = 1; const pageSize = 50; const API = "http://127.0.0.1:8000";

        async function loadDashboard(subject) {
            setLoading(true, `âš¡ Loading ${subject} records...`);
            try {
                const response = await fetch(`${API}/api/reports/paginated?subject=${subject}`);
                const res = await response.json();

                if (res.status === "error") {
                    alert(`Data Notice: ${res.message}`);
                    setLoading(false, "No data available for this view.");
                    return;
                }

                masterData = res.data; masterCols = res.columns; currentPage = 1;
                renderAll();
                setLoading(false, `${subject} Dashboard Loaded.`);
            } catch (e) { alert("Network Error: Backend is not responding."); setLoading(false, "System Error."); }
        }

        async function askAI() {
            setLoading(true, "ðŸ¤– Analyzing intent...");
            const body = { extraction_id: document.getElementById('ext_id').value, question: document.getElementById('q').value };
            try {
                const genRes = await (await fetch(`${API}/generate_sql`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })).json();
                if (genRes.error) { alert(genRes.error); setLoading(false, "AI Failed."); return; }

                const runRes = await (await fetch(`${API}/run_report`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sql: genRes.generated_sql }) })).json();
                masterData = runRes.data; masterCols = runRes.columns; currentPage = 1;
                renderAll();
                setLoading(false, `AI Specialist Mode: ${genRes.ai_identified_ids}`);
            } catch (e) { alert("AI Search Failed."); setLoading(false, "Search Error."); }
        }

        function setLoading(isLoading, text) {
            document.getElementById('statusInfo').innerText = text;
            document.querySelectorAll('button').forEach(b => b.disabled = isLoading);
        }

        function renderAll() {
            document.getElementById('reportArea').classList.remove('d-none');
            renderPaginationUI();
            displayPageRows();
        }

        function renderPaginationUI() {
            const totalPages = Math.ceil(masterData.length / pageSize);
            const container = document.getElementById('paginationControls');
            let html = `<button onclick="goToPage(${currentPage - 1})" class="btn btn-sm btn-dark" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>`;
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `<button onclick="goToPage(${i})" class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'} mx-1">${i}</button>`;
            }
            html += `<button onclick="goToPage(${currentPage + 1})" class="btn btn-sm btn-dark" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            container.innerHTML = html;
            document.getElementById('statsInfo').innerText = `Page ${currentPage} of ${totalPages} (Records: ${masterData.length})`;
        }

        function goToPage(page) { currentPage = page; renderPaginationUI(); displayPageRows(); }

        function displayPageRows() {
            const start = (currentPage - 1) * pageSize;
            const pageRows = masterData.slice(start, start + pageSize);
            document.getElementById('h').innerHTML = `<tr>${masterCols.map(c => `<th>${c}</th>`).join('')}</tr>`;
            document.getElementById('b').innerHTML = pageRows.map(r => `<tr>${masterCols.map(c => `<td>${r[c] || '0.0'}</td>`).join('')}</tr>`).join('');
        }
    </script>
</body>

</html>